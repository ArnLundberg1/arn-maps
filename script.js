// ============================
// üåç Language support
// ============================
const i18n = {
  enUS: {
    name: "English (USA)",
    placeholder: "Enter destination",
    directions: "Directions",
    you_are_here: "You are here",
    no_instructions: "No directions available.",
    alert_need_location: "Please click ‚ÄòMy Location‚Äô first.",
    alert_dest_not_found: "Destination not found.",
    alert_no_route_yet: "No route yet. Click ‚ÄòView Route‚Äô first.",
    alert_nav_started: "Navigation started. Your position will update.",
    alert_no_gps: "Geolocation not supported.",
    alert_get_location_failed: "Could not get your location.",
    tt_location: "My Location",
    tt_route: "View Route",
    tt_nav: "Start Navigation"
  },
  enUK: {
    name: "English (UK)",
    placeholder: "Enter destination",
    directions: "Directions",
    you_are_here: "You are here",
    no_instructions: "No directions available.",
    alert_need_location: "Please click ‚ÄòMy Location‚Äô first.",
    alert_dest_not_found: "Destination not found.",
    alert_no_route_yet: "No route yet. Click ‚ÄòView Route‚Äô first.",
    alert_nav_started: "Navigation started. Your position will update.",
    alert_no_gps: "Geolocation not supported.",
    alert_get_location_failed: "Could not get your location.",
    tt_location: "My Location",
    tt_route: "View Route",
    tt_nav: "Start Navigation"
  },
  sv: {
    name: "Svenska",
    placeholder: "Skriv destination",
    directions: "V√§gbeskrivning",
    you_are_here: "Du √§r h√§r",
    no_instructions: "Inga v√§gbeskrivningar tillg√§ngliga.",
    alert_need_location: "Klicka p√• ‚ÄòMin plats‚Äô f√∂rst.",
    alert_dest_not_found: "Destinationen hittades inte.",
    alert_no_route_yet: "Ingen rutt √§nnu. Klicka ‚ÄòVisa rutt‚Äô f√∂rst.",
    alert_nav_started: "Navigering startad. Din position uppdateras.",
    alert_no_gps: "Platsdelning st√∂ds ej.",
    alert_get_location_failed: "Kunde inte h√§mta din plats.",
    tt_location: "Min plats",
    tt_route: "Visa rutt",
    tt_nav: "Starta navigering"
  },
  tr: {
    name: "T√ºrk√ße",
    placeholder: "Hedef girin",
    directions: "Yol Tarifi",
    you_are_here: "Buradasƒ±nƒ±z",
    no_instructions: "Yol tarifi mevcut deƒüil.",
    alert_need_location: "√ñnce ‚ÄòKonumum‚Äô d√ºƒümesine basƒ±n.",
    alert_dest_not_found: "Hedef bulunamadƒ±.",
    alert_no_route_yet: "Hen√ºz rota yok. √ñnce ‚ÄòRotayƒ± G√∂ster‚Äôe tƒ±klayƒ±n.",
    alert_nav_started: "Navigasyon ba≈üladƒ±. Konumunuz g√ºncellenecek.",
    alert_no_gps: "Konum √∂zelliƒüi desteklenmiyor.",
    alert_get_location_failed: "Konumunuz alƒ±namadƒ±.",
    tt_location: "Konumum",
    tt_route: "Rotayƒ± G√∂ster",
    tt_nav: "Navigasyonu Ba≈ülat"
  },
  no: {
    name: "Norsk",
    placeholder: "Skriv destinasjon",
    directions: "Veibeskrivelse",
    you_are_here: "Du er her",
    no_instructions: "Ingen veibeskrivelser tilgjengelig.",
    alert_need_location: "Klikk ‚ÄòMin posisjon‚Äô f√∏rst.",
    alert_dest_not_found: "Destinasjonen ble ikke funnet.",
    alert_no_route_yet: "Ingen rute enn√•. Klikk ‚ÄòVis rute‚Äô f√∏rst.",
    alert_nav_started: "Navigasjon startet. Posisjonen din oppdateres.",
    alert_no_gps: "Stedsdeling st√∏ttes ikke.",
    alert_get_location_failed: "Kunne ikke hente posisjonen din.",
    tt_location: "Min posisjon",
    tt_route: "Vis rute",
    tt_nav: "Start navigasjon"
  },
  fi: {
    name: "Suomi",
    placeholder: "Anna kohde",
    directions: "Reittiohjeet",
    you_are_here: "Olet t√§ss√§",
    no_instructions: "Reittiohjeita ei saatavilla.",
    alert_need_location: "Napsauta ensin ‚ÄòSijaintini‚Äô.",
    alert_dest_not_found: "Kohdetta ei l√∂ytynyt.",
    alert_no_route_yet: "Ei viel√§ reitti√§. Valitse ‚ÄòN√§yt√§ reitti‚Äô ensin.",
    alert_nav_started: "Navigointi aloitettu. Sijainti p√§ivittyy.",
    alert_no_gps: "Sijainti ei ole tuettu.",
    alert_get_location_failed: "Sijaintiasi ei voitu hakea.",
    tt_location: "Sijaintini",
    tt_route: "N√§yt√§ reitti",
    tt_nav: "Aloita navigointi"
  },
  ru: {
    name: "–†—É—Å—Å–∫–∏–π",
    placeholder: "–í–≤–µ–¥–∏—Ç–µ –ø—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è",
    directions: "–ú–∞—Ä—à—Ä—É—Ç",
    you_are_here: "–í—ã –∑–¥–µ—Å—å",
    no_instructions: "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.",
    alert_need_location: "–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ ¬´–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ¬ª.",
    alert_dest_not_found: "–ü—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω.",
    alert_no_route_yet: "–ú–∞—Ä—à—Ä—É—Ç–∞ –Ω–µ—Ç. –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∫–∞–∑–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç¬ª.",
    alert_nav_started: "–ù–∞–≤–∏–≥–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞. –í–∞—à–∞ –ø–æ–∑–∏—Ü–∏—è –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è.",
    alert_no_gps: "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.",
    alert_get_location_failed: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.",
    tt_location: "–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ",
    tt_route: "–ü–æ–∫–∞–∑–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç",
    tt_nav: "–ù–∞—á–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é"
  },
  de: {
    name: "Deutsch",
    placeholder: "Ziel eingeben",
    directions: "Wegbeschreibung",
    you_are_here: "Sie sind hier",
    no_instructions: "Keine Wegbeschreibung verf√ºgbar.",
    alert_need_location: "Bitte zuerst ‚ÄòMein Standort‚Äô klicken.",
    alert_dest_not_found: "Ziel nicht gefunden.",
    alert_no_route_yet: "Noch keine Route. Erst ‚ÄòRoute anzeigen‚Äô klicken.",
    alert_nav_started: "Navigation gestartet. Ihre Position wird aktualisiert.",
    alert_no_gps: "Geolokalisierung wird nicht unterst√ºtzt.",
    alert_get_location_failed: "Ihr Standort konnte nicht ermittelt werden.",
    tt_location: "Mein Standort",
    tt_route: "Route anzeigen",
    tt_nav: "Navigation starten"
  },
  nl: {
    name: "Nederlands",
    placeholder: "Voer bestemming in",
    directions: "Routebeschrijving",
    you_are_here: "U bent hier",
    no_instructions: "Geen routebeschrijving beschikbaar.",
    alert_need_location: "Klik eerst op ‚ÄòMijn locatie‚Äô.",
    alert_dest_not_found: "Bestemming niet gevonden.",
    alert_no_route_yet: "Nog geen route. Klik eerst ‚ÄòRoute bekijken‚Äô.",
    alert_nav_started: "Navigatie gestart. Uw positie wordt bijgewerkt.",
    alert_no_gps: "Geolocatie wordt niet ondersteund.",
    alert_get_location_failed: "Uw locatie kon niet worden opgehaald.",
    tt_location: "Mijn locatie",
    tt_route: "Route bekijken",
    tt_nav: "Navigatie starten"
  },
  es: {
    name: "Espa√±ol",
    placeholder: "Ingrese destino",
    directions: "Indicaciones",
    you_are_here: "Est√°s aqu√≠",
    no_instructions: "No hay indicaciones disponibles.",
    alert_need_location: "Haga clic primero en ‚ÄòMi ubicaci√≥n‚Äô.",
    alert_dest_not_found: "Destino no encontrado.",
    alert_no_route_yet: "Sin ruta a√∫n. Primero ‚ÄòVer ruta‚Äô.",
    alert_nav_started: "Navegaci√≥n iniciada. Tu posici√≥n se actualizar√°.",
    alert_no_gps: "La geolocalizaci√≥n no es compatible.",
    alert_get_location_failed: "No se pudo obtener tu ubicaci√≥n.",
    tt_location: "Mi ubicaci√≥n",
    tt_route: "Ver ruta",
    tt_nav: "Iniciar navegaci√≥n"
  },
  it: {
    name: "Italiano",
    placeholder: "Inserisci destinazione",
    directions: "Indicazioni",
    you_are_here: "Sei qui",
    no_instructions: "Nessuna indicazione disponibile.",
    alert_need_location: "Fai prima clic su ‚ÄòLa mia posizione‚Äô.",
    alert_dest_not_found: "Destinazione non trovata.",
    alert_no_route_yet: "Ancora nessun percorso. Clicca ‚ÄòVedi percorso‚Äô prima.",
    alert_nav_started: "Navigazione avviata. La tua posizione verr√† aggiornata.",
    alert_no_gps: "Geolocalizzazione non supportata.",
    alert_get_location_failed: "Impossibile ottenere la tua posizione.",
    tt_location: "La mia posizione",
    tt_route: "Vedi percorso",
    tt_nav: "Avvia navigazione"
  }
};

// Preferred language detection
function detectLang() {
  const nav = (navigator.language || 'en-US').toLowerCase();
  if (nav.startsWith('sv')) return 'sv';
  if (nav.startsWith('en-gb')) return 'enUK';
  if (nav.startsWith('en')) return 'enUS';
  if (nav.startsWith('tr')) return 'tr';
  if (nav.startsWith('no') || nav.startsWith('nb') || nav.startsWith('nn')) return 'no';
  if (nav.startsWith('fi')) return 'fi';
  if (nav.startsWith('ru')) return 'ru';
  if (nav.startsWith('de')) return 'de';
  if (nav.startsWith('nl')) return 'nl';
  if (nav.startsWith('es')) return 'es';
  if (nav.startsWith('it')) return 'it';
  return 'enUS';
}

let currentLang = detectLang();
const LANGS = Object.keys(i18n);

// Helpers to access UI elements
const $ = (id) => document.getElementById(id);
const toInput = $('to');
const langSelect = $('language');
const directionsTitle = $('directionsTitle');
const btnLoc = $('locBtn');
const btnView = $('viewBtn');
const btnNav = $('navBtn');

// Populate language dropdown
(function populateLanguageSelect() {
  // If index.html already has options, clear them to avoid duplicates
  while (langSelect.firstChild) langSelect.removeChild(langSelect.firstChild);
  LANGS.forEach(code => {
    const opt = document.createElement('option');
    opt.value = code;
    opt.textContent = i18n[code].name;
    langSelect.appendChild(opt);
  });
  langSelect.value = currentLang;
})();

// Apply language to UI
function applyLanguage() {
  const t = i18n[currentLang] || i18n.enUS;
  toInput.placeholder = t.placeholder;
  directionsTitle.textContent = t.directions;
  btnLoc.title = t.tt_location;
  btnView.title = t.tt_route;
  btnNav.title = t.tt_nav;
}
applyLanguage();

langSelect.addEventListener('change', () => {
  currentLang = langSelect.value;
  applyLanguage();
  rebuildGeocoder(); // update accept-language for geocoding
});

// ============================
// üó∫Ô∏è Map + Geocoder Setup
// ============================
const map = L.map('map').setView([59.3293, 18.0686], 6); // Stockholm default
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

let userLocation = null;
let control = null;
let currentRoute = null;
let navMarker = null;
let geocoder = null;

function rebuildGeocoder() {
  const langForNominatim = currentLang === 'enUK' ? 'en-GB' :
                           currentLang === 'enUS' ? 'en-US' :
                           currentLang; // use code as-is for others
  geocoder = L.Control.Geocoder.nominatim({
    geocodingQueryParams: { 'accept-language': langForNominatim }
  });
}
rebuildGeocoder();

// ============================
// üìç Get User Location
// ============================
function useMyLocation() {
  const t = i18n[currentLang] || i18n.enUS;
  if (!navigator.geolocation) {
    alert(t.alert_no_gps);
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      userLocation = L.latLng(pos.coords.latitude, pos.coords.longitude);
      L.marker(userLocation).addTo(map).bindPopup(t.you_are_here).openPopup();
      map.setView(userLocation, 14);
    },
    () => alert(t.alert_get_location_failed),
    { enableHighAccuracy: true, timeout: 15000 }
  );
}

// ============================
// üîç View Route (calculate + zoom)
// ============================
function viewRoute() {
  const t = i18n[currentLang] || i18n.enUS;
  const to = toInput.value.trim();
  if (!userLocation) {
    alert(t.alert_need_location);
    return;
  }
  if (!to) return;

  if (control) map.removeControl(control);

  control = L.Routing.control({
    waypoints: [],
    router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
    geocoder: geocoder,
    show: false,
    routeWhileDragging: false,
    createMarker: (i, wp) => L.marker(wp.latLng, { draggable: false })
  }).addTo(map);

  // Attach event BEFORE setting waypoints to avoid race conditions
  control.on('routesfound', function(e) {
    const stepsDiv = $('steps');
    stepsDiv.innerHTML = "";
    const route = e.routes[0];
    currentRoute = route; // ‚úÖ so Navigation works

    // Extract instructions safely
    let instructions = [];
    if (route.instructions && route.instructions.length) {
      instructions = route.instructions.map(s => s.text);
    } else if (route.legs && route.legs.length && route.legs[0].steps) {
      // Fallback (not typical for LRM, but just in case)
      instructions = route.legs[0].steps.map(step => {
        if (step.maneuver && step.maneuver.instruction) return step.maneuver.instruction;
        // crude fallback string
        const typ = step.maneuver?.type || 'Continue';
        const mod = step.maneuver?.modifier ? ` ${step.maneuver.modifier}` : '';
        return `${typ}${mod}`;
      });
    }

    if (instructions.length === 0) {
      stepsDiv.innerHTML = `<p>${t.no_instructions}</p>`;
    } else {
      instructions.forEach(text => {
        const p = document.createElement('p');
        p.textContent = `‚û°Ô∏è ${text}`;
        stepsDiv.appendChild(p);
      });
    }

    // Fit map to route
    try {
      map.fitBounds(L.Routing.line(route).getBounds(), { padding: [30, 30] });
    } catch {
      // If that fails for some reason, just keep current view
    }
  });

  // Geocode destination with selected language
  geocoder.geocode(to, function(results) {
    if (results && results.length > 0) {
      const toCoord = results[0].center;
      control.setWaypoints([userLocation, toCoord]);
    } else {
      alert(t.alert_dest_not_found);
    }
  });
}

// ============================
// ‚ñ∂Ô∏è Start Live Navigation (GPS follows)
// ============================
function startNavigation() {
  const t = i18n[currentLang] || i18n.enUS;
  if (!currentRoute) {
    alert(t.alert_no_route_yet);
    return;
  }
  if (!navigator.geolocation) {
    alert(t.alert_no_gps);
    return;
  }

  alert(t.alert_nav_started);

  navigator.geolocation.watchPosition(pos => {
    const latlng = [pos.coords.latitude, pos.coords.longitude];

    if (!navMarker) {
      navMarker = L.marker(latlng, {
        icon: L.icon({
          iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png",
          iconSize: [30, 30]
        })
      }).addTo(map);
    } else {
      navMarker.setLatLng(latlng);
    }
    map.setView(latlng, 16);
  }, () => {
    alert(t.alert_get_location_failed);
  }, { enableHighAccuracy: true });
}

// ============================
// üéõÔ∏è Hook up Buttons
// ============================
btnLoc.addEventListener("click", useMyLocation);
btnView.addEventListener("click", viewRoute);
btnNav.addEventListener("click", startNavigation);
